---
import { getCollection, type CollectionEntry } from "astro:content";
import { Image, getImage } from "astro:assets";
import type { ImageMetadata } from "astro";

// Load all images from src/images
const images = import.meta.glob<{ default: ImageMetadata }>('/src/images/*.{jpeg,jpg,png,gif,webp}');

// Helper to get image path
async function getImageSrc(imageName: string | undefined) {
  if (!imageName) return null;
  const imagePath = `/src/images/${imageName}`;
  const imageModule = images[imagePath];
  if (imageModule) {
    const image = await imageModule();
    return image.default;
  }
  return null;
}

let peopleEntries: CollectionEntry<"people">[] = [];
let error: string | null = null;

try {
  peopleEntries = await getCollection("people");
} catch (e) {
  error = "Failed to load people entries. Please try refreshing the page.";
  console.error("Error loading people:", e);
}

const sortedEntries = peopleEntries.sort(
  (a: CollectionEntry<"people">, b: CollectionEntry<"people">) => {
    return a.data.birth_date.localeCompare(b.data.birth_date);
  }
);

// Render markdown content for each entry
const entriesWithContent = await Promise.all(
  sortedEntries.map(async (entry) => {
    const { Content } = await entry.render();
    // Only load image if entry has one defined
    const imageSrc = entry.data.image ? await getImageSrc(entry.data.image) : null;

    // Generate larger version for modal (848px wide max)
    let modalImageSrc = null;
    if (imageSrc) {
      const largeImage = await getImage({ src: imageSrc, width: 848, format: 'webp' });
      modalImageSrc = largeImage.src;
    }

    return { entry, Content, imageSrc, modalImageSrc };
  })
);

// Helper function to safely parse year from date string
function parseYear(dateString: string): number {
  try {
    if (dateString.includes('-')) {
      const year = parseInt(dateString.split('-')[0], 10);
      return isNaN(year) ? 0 : year;
    }
    const year = parseInt(dateString, 10);
    return isNaN(year) ? 0 : year;
  } catch (e) {
    console.error("Error parsing date:", dateString, e);
    return 0;
  }
}

// Helper function to format dates nicely
function formatDateRange(birthDate: string, deathDate?: string): string {
  const birthYear = parseYear(birthDate);
  const deathYear = deathDate ? parseYear(deathDate) : null;

  if (deathYear) {
    return `${birthYear}–${deathYear}`;
  }
  return `${birthYear}–present`;
}
---

{error ? (
  <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" role="alert">
    <p class="font-medium">Error</p>
    <p class="text-sm">{error}</p>
  </div>
) : sortedEntries.length === 0 ? (
  <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg" role="alert">
    <p class="font-medium">No entries found</p>
    <p class="text-sm">There are no people entries to display yet.</p>
  </div>
) : (
<div>
  <!-- Search Bar -->
  <div class="mb-6">
    <div class="relative">
      <input
        type="text"
        id="people-search"
        placeholder="Search by name, occupation, or significance..."
        class="w-full px-4 py-3 pl-11 border border-gray-300 rounded-lg focus:ring-2 focus:ring-offset-2 shadow-sm"
        style="--tw-ring-color: rgb(226, 111, 4);"
        aria-label="Search people entries"
      />
      <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
  </div>

  <!-- No Results Message -->
  <div id="people-no-results" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg mb-4">
    <p class="font-medium">No matching entries found</p>
    <p class="text-sm">Try adjusting your search.</p>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
  <table class="w-full bg-white shadow-md rounded-lg overflow-hidden">
    <thead class="text-white" style="background-color: rgb(226, 111, 4);">
      <tr>
        <th class="px-6 py-3 text-left text-sm font-semibold"></th>
        <th class="px-6 py-3 text-left text-sm font-semibold">Name</th>
        <th class="px-6 py-3 text-left text-sm font-semibold">Lifespan</th>
        <th class="px-6 py-3 text-left text-sm font-semibold">Occupations</th>
        <th class="px-6 py-3 text-left text-sm font-semibold">Significance</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      {entriesWithContent.map(({ entry, imageSrc }, index) => (
          <tr class={index % 2 === 0 ? "bg-white" : "bg-gray-50"} data-lang={entry.id.split('/')[0]}>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {imageSrc ? (
                  <button
                    class="view-details-btn hover:opacity-80 transition-opacity"
                    data-entry-id={`people-entry-${index}`}
                    title="Click to view full biography"
                  >
                    <Image
                      src={imageSrc}
                      alt={entry.data.name}
                      width={192}
                      height={192}
                      class="w-16 h-16 object-cover rounded"
                      style="min-width: 4rem; min-height: 4rem;"
                      quality={90}
                    />
                  </button>
                ) : (
                  <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center" style="min-width: 4rem; min-height: 4rem;">
                    <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                )}
              </td>
              <td class="px-6 py-4 text-sm">
                <button
                  class="view-details-btn text-left font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 rounded transition-all"
                  style="color: rgb(226, 111, 4); --tw-ring-color: rgb(226, 111, 4);"
                  onmouseover="this.style.color='rgb(180, 83, 9)'; this.style.textDecoration='underline'; this.style.textDecorationColor='rgb(180, 83, 9)'; this.style.textDecorationThickness='2px'"
                  onmouseout="this.style.color='rgb(226, 111, 4)'; this.style.textDecoration='none'"
                  data-entry-id={`people-entry-${index}`}
                  title="Click to view full biography"
                >
                  {entry.data.name}
                </button>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {formatDateRange(entry.data.birth_date, entry.data.death_date)}
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {entry.data.occupations?.slice(0, 2).join(', ') || 'N/A'}
                {entry.data.occupations && entry.data.occupations.length > 2 && '...'}
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {entry.data.significance.substring(0, 100)}...
              </td>
          </tr>
      ))}
    </tbody>
  </table>
  </div>
</div>
)}

<!-- Hidden content for modal (each entry's full markdown) -->
{entriesWithContent.map(({ entry, Content, modalImageSrc }, index) => (
  <div
    id={`people-entry-${index}`}
    class="hidden entry-content"
    data-name={entry.data.name}
    data-birth-date={entry.data.birth_date}
    data-death-date={entry.data.death_date || ''}
    data-birth-place={entry.data.birth_place || ''}
    data-death-place={entry.data.death_place || ''}
    data-occupations={JSON.stringify(entry.data.occupations || [])}
    data-sources={JSON.stringify(entry.data.sources || [])}
    data-image={modalImageSrc || ''}
    data-image-credit={entry.data.image_credit || ''}
  >
    <Content />
  </div>
))}

<!-- Modal -->
<div id="people-details-modal" class="hidden fixed inset-0 z-[1100] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/50 transition-opacity" id="people-modal-backdrop"></div>

  <!-- Modal Content -->
  <div class="relative flex min-h-full items-center justify-center p-4 sm:p-0">
    <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-full max-w-4xl sm:my-8">
      <!-- Header -->
      <div class="px-4 py-4 sm:px-6" style="background-color: rgb(226, 111, 4);">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="text-xl font-semibold text-white" id="people-modal-title"></h3>
            <p class="mt-1 text-sm opacity-90 text-white" id="people-modal-subtitle"></p>
          </div>
          <button
            type="button"
            class="ml-3 inline-flex rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white p-2"
            style="background-color: rgb(180, 83, 9);"
            onmouseover="this.style.backgroundColor='rgb(154, 52, 18)'"
            onmouseout="this.style.backgroundColor='rgb(180, 83, 9)'"
            id="people-close-modal"
            aria-label="Close modal"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Image (if available) -->
      <div id="people-modal-image-container" class="hidden px-4 py-5 sm:px-6">
        <div id="people-modal-image-wrapper" class="w-full flex justify-center">
          <img id="people-modal-image" src="" alt="" class="w-full object-contain" style="max-width: 848px; height: auto;" loading="lazy" />
        </div>
        <div id="people-modal-image-credit" class="pt-2 text-xs text-gray-700"></div>
      </div>

      <!-- Body -->
      <div class="bg-white px-4 py-5 sm:p-6">
        <div class="space-y-4">
          <!-- Life info -->
          <div id="people-modal-info" class="text-sm text-gray-600"></div>

          <!-- Occupations -->
          <div id="people-modal-occupations-container" class="hidden">
            <div class="flex flex-wrap gap-2" id="people-modal-occupations"></div>
          </div>

          <!-- Rich Content Area -->
          <div id="people-modal-content" class="prose prose-sm max-w-none">
            <!-- Content will be injected here -->
          </div>

          <!-- Sources -->
          <div id="people-modal-sources-container" class="hidden pt-4 border-t border-gray-200">
            <h4 class="font-semibold text-gray-900 mb-2">Sources:</h4>
            <ul class="space-y-1 text-sm" id="people-modal-sources"></ul>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
        <button
          type="button"
          class="inline-flex w-full justify-center rounded-md px-4 py-2 text-sm font-semibold text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 sm:ml-3 sm:w-auto"
          style="background-color: rgb(226, 111, 4); --tw-ring-color: rgb(226, 111, 4);"
          onmouseover="this.style.backgroundColor='rgb(180, 83, 9)'"
          onmouseout="this.style.backgroundColor='rgb(226, 111, 4)'"
          id="people-close-modal-footer"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Helper function to parse year
  function parseYear(dateString: string): number {
    if (!dateString) return 0;
    if (dateString.includes('-')) {
      return parseInt(dateString.split('-')[0], 10);
    }
    return parseInt(dateString, 10);
  }

  // Helper function to format date range
  function formatDateRange(birthDate: string, deathDate: string): string {
    const birthYear = parseYear(birthDate);
    const deathYear = deathDate ? parseYear(deathDate) : null;

    if (deathYear) {
      return `${birthYear}–${deathYear}`;
    }
    return `${birthYear}–present`;
  }

  // Modal functionality
  const modal = document.getElementById('people-details-modal');
  const modalBackdrop = document.getElementById('people-modal-backdrop');
  const closeButtons = [document.getElementById('people-close-modal'), document.getElementById('people-close-modal-footer'), modalBackdrop];

  function openModal(entryId: string) {
    const entryElement = document.getElementById(entryId);
    if (!entryElement) return;

    const modalTitle = document.getElementById('people-modal-title');
    const modalSubtitle = document.getElementById('people-modal-subtitle');
    const modalInfo = document.getElementById('people-modal-info');
    const modalOccupationsContainer = document.getElementById('people-modal-occupations-container');
    const modalOccupations = document.getElementById('people-modal-occupations');
    const modalContent = document.getElementById('people-modal-content');
    const modalSourcesContainer = document.getElementById('people-modal-sources-container');
    const modalSources = document.getElementById('people-modal-sources');
    const modalImageContainer = document.getElementById('people-modal-image-container');
    const modalImage = document.getElementById('people-modal-image') as HTMLImageElement;
    const modalImageCredit = document.getElementById('people-modal-image-credit');

    // Get data from the hidden entry element
    const name = entryElement.dataset.name || '';
    const birthDate = entryElement.dataset.birthDate || '';
    const deathDate = entryElement.dataset.deathDate || '';
    const birthPlace = entryElement.dataset.birthPlace || '';
    const deathPlace = entryElement.dataset.deathPlace || '';
    const occupations = JSON.parse(entryElement.dataset.occupations || '[]');
    const sources = JSON.parse(entryElement.dataset.sources || '[]');
    const image = entryElement.dataset.image || '';
    const imageCredit = entryElement.dataset.imageCredit || '';

    if (modalTitle) modalTitle.textContent = name;
    if (modalSubtitle) modalSubtitle.textContent = formatDateRange(birthDate, deathDate);

    // Handle image display
    if (image && modalImageContainer && modalImage) {
      try {
        modalImage.src = image;
        modalImage.alt = name;

        // Apply special styling for O'Hearn's image to reduce pixelation
        if (name.includes("O'Hearn")) {
          modalImage.style.maxWidth = '212px'; // Quarter of the normal 848px
        } else {
          modalImage.style.maxWidth = '848px'; // Normal size
        }

        if (imageCredit && modalImageCredit) {
          modalImageCredit.textContent = imageCredit;
        } else if (modalImageCredit) {
          modalImageCredit.textContent = '';
        }
        modalImageContainer.classList.remove('hidden');
      } catch (err) {
        console.error('Error loading image:', err);
        modalImageContainer.classList.add('hidden');
      }
    } else if (modalImageContainer) {
      modalImageContainer.classList.add('hidden');
    }

    // Birth and death places
    if (modalInfo) {
      const birthInfo = birthPlace ? `Born: ${birthPlace}` : '';
      const deathInfo = deathPlace ? `Died: ${deathPlace}` : '';
      const separator = birthInfo && deathInfo ? ' • ' : '';
      modalInfo.textContent = birthInfo + separator + deathInfo;

      if (birthInfo || deathInfo) {
        modalInfo.classList.remove('hidden');
      } else {
        modalInfo.classList.add('hidden');
      }
    }

    // Occupations as badges
    if (occupations.length > 0 && modalOccupationsContainer && modalOccupations) {
      modalOccupations.innerHTML = occupations.map((occ: string) => `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          ${occ}
        </span>
      `).join('');
      modalOccupationsContainer.classList.remove('hidden');
    } else if (modalOccupationsContainer) {
      modalOccupationsContainer.classList.add('hidden');
    }

    // Clone and insert the rich content
    if (modalContent) {
      modalContent.innerHTML = entryElement.innerHTML;
    }

    // Handle sources
    if (sources.length > 0 && modalSourcesContainer && modalSources) {
      modalSources.innerHTML = sources.map((source: any) => `
        <li class="flex items-start">
          ${source.url ? `
            <svg class="h-5 w-5 mr-2 flex-shrink-0" style="color: rgb(226, 111, 4);" fill="currentColor" viewBox="0 0 20 20">
              <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
              <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
            </svg>
            <a href="${source.url}" target="_blank" rel="noopener noreferrer" style="color: rgb(226, 111, 4);" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${source.title}</a>
          ` : `<span class="text-gray-700">${source.title}</span>`}
        </li>
      `).join('');
      modalSourcesContainer.classList.remove('hidden');
    } else if (modalSourcesContainer) {
      modalSourcesContainer.classList.add('hidden');
    }

    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // Add click handlers to all view details buttons
  document.querySelectorAll('.view-details-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      const btn = e.currentTarget as HTMLButtonElement;
      const entryId = btn.dataset.entryId;
      if (entryId) {
        openModal(entryId);
      }
    });
  });

  // Close modal handlers
  closeButtons.forEach(btn => {
    if (btn) {
      btn.addEventListener('click', closeModal);
    }
  });

  // ESC key to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  // Language filtering functionality
  const currentLanguage = localStorage.getItem('preferred-language') || 'en';

  // Search functionality
  const searchInput = document.getElementById('people-search') as HTMLInputElement;
  const noResults = document.getElementById('people-no-results') as HTMLElement;
  const tableRows = document.querySelectorAll('tbody tr');

  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    tableRows.forEach((row) => {
      const rowElement = row as HTMLElement;
      const cells = rowElement.querySelectorAll('td');

      if (cells.length < 4) return;

      const name = cells[0].textContent?.toLowerCase() || '';
      const occupations = cells[2].textContent?.toLowerCase() || '';
      const significance = cells[3].textContent?.toLowerCase() || '';
      const rowLang = rowElement.dataset.lang || 'en';

      // Check language match
      const matchesLanguage = rowLang === currentLanguage;

      // Check search match
      const matchesSearch = !searchTerm ||
        name.includes(searchTerm) ||
        occupations.includes(searchTerm) ||
        significance.includes(searchTerm);

      // Show/hide row based on both language and search
      if (matchesLanguage && matchesSearch) {
        rowElement.style.display = '';
        visibleCount++;
      } else {
        rowElement.style.display = 'none';
      }
    });

    // Show/hide no results message
    if (visibleCount === 0 && searchTerm) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Run filter on page load
  filterTable();

  // Event listener
  if (searchInput) {
    searchInput.addEventListener('input', filterTable);
  }
</script>
